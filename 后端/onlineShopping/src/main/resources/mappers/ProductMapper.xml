<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.online_shopping_project.onlineshopping.mapper.ProductMapper">
    <!-- 字段与Product实体映射 -->
    <resultMap id="ProductMap" type="com.online_shopping_project.onlineshopping.entity.Product">
        <id     column="id"           property="id"/>
        <result column="category_id"  property="categoryId"/>
        <result column="title"        property="title"/>
        <result column="sub_title"    property="subTitle"/>
        <result column="price"        property="price"/>
        <result column="stock"        property="stock"/>
        <result column="status"       property="status"/>
        <result column="main_img"     property="mainImg"/>
        <result column="attrs"        property="attrs"/>
        <result column="created_at"   property="createdAt"/>
        <result column="updated_at"   property="updatedAt"/>
    </resultMap>
    <!-- 分页由 PageHelper 在运行时拦截，无需在 SQL 写 limit -->
    <!-- 动态条件查询商品信息 -->
    <select id="selectByQuery" parameterType="com.online_shopping_project.onlineshopping.entity.query.ProductQuery"
            resultMap="ProductMap">
        SELECT id, category_id, title, sub_title, price, stock, status, main_img, attrs, created_at, updated_at
        FROM product
        <where>
            status = 1
            <if test="q.categoryIds != null and q.categoryIds.size > 0">
                AND category_id IN
                <foreach item="id" collection="q.categoryIds" open="(" separator="," close=")">
                    #{id}
                </foreach>
            </if>
            <if test="q.categoryId != null and (q.categoryIds == null or q.categoryIds.size == 0)">
                AND category_id = #{q.categoryId}
            </if>
            <if test="q.keyword != null and q.keyword != ''">
                AND ( title LIKE CONCAT('%', #{q.keyword}, '%')
                OR sub_title LIKE CONCAT('%', #{q.keyword}, '%') )
            </if>
        </where>
        <!-- 排序规则 -->
        <choose>
            <when test="q.orderBy == 'price_asc'">
                ORDER BY price ASC, id DESC
            </when>
            <when test="q.orderBy == 'price_desc'">
                ORDER BY price DESC, id DESC
            </when>
            <when test="q.orderBy == 'time_desc'">
                ORDER BY updated_at DESC
            </when>
            <otherwise>
                ORDER BY id DESC
            </otherwise>
        </choose>
    </select>
    <!-- 后台管理专用  -->
    <select id="selectByAdminQuery" resultMap="ProductMap">   <!-- 后台条件查询 -->
        SELECT id, category_id, title, sub_title, price, stock, status, main_img, attrs, created_at, updated_at
        FROM product
        <where>
            <if test="title != null and title != ''">
                AND title LIKE CONCAT('%', #{title}, '%')
            </if>
            <if test="categoryId != null">
                AND category_id = #{categoryId}
            </if>
            <if test="status != null">
                AND status = #{status}
            </if>
        </where>
        ORDER BY id DESC
    </select>
    <select id="selectById" resultMap="ProductMap">   <!-- 后台按ID查商品 -->
        SELECT id, category_id, title, sub_title, price, stock, status, main_img, attrs, created_at, updated_at
        FROM product
        WHERE id = #{id}
    </select>
    <insert id="insert">   <!-- 后台新增商品 -->
        INSERT INTO product (category_id, title, sub_title, price, stock, status,
                             main_img, attrs, created_at, updated_at)
        VALUES (#{categoryId}, #{title}, #{subTitle}, #{price},
                #{stock}, #{status}, #{mainImg}, #{attrs},
                NOW(), NOW())
    </insert>
    <update id="update">  <!-- 后台修改商品 -->
        UPDATE product
        SET category_id = #{categoryId},
            title       = #{title},
            sub_title   = #{subTitle},
            price       = #{price},
            stock       = #{stock},
            status      = #{status},
            main_img    = #{mainImg},
            attrs       = #{attrs},
            updated_at  = NOW()
        WHERE id = #{id}
    </update>
    <update id="updateStatus">  <!-- 后台上下架 -->
        UPDATE product
        SET status = #{status},
            updated_at = NOW()
        WHERE id = #{id}
    </update>
</mapper>
